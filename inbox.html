<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Inbox | Paradox Mail</title>
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;800&display=swap');
        body { background: #05070a; font-family: 'Plus Jakarta Sans', sans-serif; color: #ffffff; }
        .glass-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border-radius: 28px; transition: 0.3s; }
        .glass-card:hover { background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.3); transform: scale(1.01); cursor: pointer; }
        .unread-indicator { width: 10px; height: 10px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 15px #3b82f6; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <nav class="px-8 py-5 border-b border-white/5 flex justify-between items-center bg-[#05070a]/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <img src="icon.png" class="w-10 h-10 rounded-xl shadow-lg shadow-blue-500/10">
            <h1 class="text-xl font-black italic uppercase tracking-tighter">Paradox <span class="text-blue-500">Mail</span></h1>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="hidden sm:block text-right">
                <p id="userName" class="text-xs font-black text-gray-200 tracking-tighter">...</p>
                <p id="userAddress" class="text-[9px] text-blue-500 font-bold uppercase italic">...</p>
            </div>
            <a href="send-mail.html" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition flex items-center gap-2 shadow-xl shadow-blue-600/20">
                <i class="fas fa-plus"></i> Compose
            </a>
            <button onclick="logout()" class="text-gray-600 hover:text-red-500 transition text-lg"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <main class="flex flex-1 overflow-hidden">
        <section class="flex-1 p-6 md:p-12 overflow-y-auto bg-gradient-to-b from-[#05070a] to-[#0a0c10]">
            <div class="flex justify-between items-center mb-12">
                <h2 class="text-4xl font-black italic uppercase tracking-tighter">Incoming <span class="text-blue-600">Secure</span></h2>
                <div class="text-[9px] text-gray-500 font-black uppercase tracking-[0.2em] bg-white/5 px-5 py-2 rounded-full border border-white/5 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full status-pulse"></span>
                    Cloud Sync: <span id="syncTime" class="text-blue-500 italic">Connecting...</span>
                </div>
            </div>

            <div id="mailList" class="space-y-4 max-w-5xl mx-auto">
                <div class="animate-pulse space-y-4">
                    <div class="h-24 bg-white/5 rounded-[2rem]"></div>
                    <div class="h-24 bg-white/5 rounded-[2rem]"></div>
                </div>
            </div>

            <div id="emptyView" class="hidden py-32 flex flex-col items-center justify-center text-center opacity-40">
                <i class="fas fa-ghost text-6xl mb-6 text-blue-500/50"></i>
                <h3 class="text-xl font-bold uppercase italic tracking-widest">Inbox Zero</h3>
                <p class="text-xs font-medium mt-2">No encrypted transmissions found in Paradox Core.</p>
            </div>
        </section>
    </main>

    <script type="module">
        const API_URL = "https://elitegamer859650-pauthservice.hf.space";
        
        // Session Guard
        const sessionStr = localStorage.getItem('paradox_active_session');
        if(!sessionStr) window.location.href = "auth-gateway.html";
        
        const userData = JSON.parse(sessionStr);
        // Checking nested user object from Supabase response
        const userHandle = userData.data ? userData.data.username : userData.user;

        document.getElementById('userName').innerText = userHandle.toUpperCase();
        document.getElementById('userAddress').innerText = userHandle + "@paradox.pk";

        async function loadMessages() {
            const container = document.getElementById('mailList');
            const empty = document.getElementById('emptyView');
            const syncTime = document.getElementById('syncTime');

            try {
                // Fetching from synchronized backend route
                const res = await fetch(`${API_URL}/auth/get-mails?user=${userHandle.toLowerCase()}`);
                const result = await res.json();

                syncTime.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = "";
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                container.innerHTML = "";
                
                result.data.forEach(mail => {
                    const card = document.createElement('div');
                    card.className = "glass-card p-6 flex items-center justify-between gap-5 group border border-white/5 hover:border-blue-500/30";
                    
                    const isOfficial = mail.sender.toLowerCase() === 'official' || mail.sender.toLowerCase() === 'admin';
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-5 flex-1 min-w-0">
                            <div class="w-14 h-14 rounded-2xl ${isOfficial ? 'bg-blue-600/10 text-blue-500 border-blue-500/20' : 'bg-white/5 text-gray-500 border-white/5'} flex items-center justify-center text-xl border">
                                <i class="fas ${isOfficial ? 'fa-shield-alt' : 'fa-user-secret'}"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-black text-sm italic uppercase tracking-tighter flex items-center gap-2">
                                    ${mail.sender} 
                                    ${isOfficial ? '<i class="fas fa-check-circle text-[10px] text-blue-500"></i>' : ''}
                                    <span class="text-[9px] text-blue-500/40 font-bold tracking-widest">@PARADOX.PK</span>
                                </h4>
                                <p class="text-xs font-bold text-gray-200 truncate mt-1">${mail.subject || 'Secure Transmission'}</p>
                                <p class="text-[10px] text-gray-500 truncate mt-0.5 opacity-60 italic">${mail.message || 'No content'}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-[8px] font-black text-gray-700 uppercase tracking-[0.2em] italic">Dispatched</span>
                            <div class="w-8 h-8 rounded-full flex items-center justify-center bg-white/5 group-hover:bg-blue-600 group-hover:text-white transition-all">
                                <i class="fas fa-chevron-right text-[10px]"></i>
                            </div>
                        </div>
                    `;
                    
                    // Detail view passing ID
                    card.onclick = () => window.location.href = `view-mail.html?id=${mail.id}`;
                    container.appendChild(card);
                });

            } catch (err) {
                console.error("Sync Failure:", err);
                syncTime.innerText = "OFFLINE";
                syncTime.className = "text-red-500 font-black";
            }
        }

        window.logout = () => {
            localStorage.removeItem('paradox_active_session');
            window.location.href = "auth-gateway.html";
        };

        // Initial Boot
        loadMessages();
        // Auto Sync every 30 seconds to save server resources
        setInterval(loadMessages, 30000); 
    </script>
</body>
</html>
